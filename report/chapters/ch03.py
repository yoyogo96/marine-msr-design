"""
Chapter 3: Thermal-Hydraulic Analysis
40 MWth Marine Molten Salt Reactor Conceptual Design Report

Provides ~15 pages of detailed Korean technical content covering:
  3.1 Analysis overview
  3.2 Flow conditions
  3.3 Heat transfer model
  3.4 Temperature distribution results
  3.5 Thermal limit evaluation
  3.6 Loop hydraulic analysis
  3.7 Natural circulation analysis
  3.8 System temperature map
  3.9 Summary
"""


def write_chapter(pdf):
    """Write Chapter 3 to the PDF document."""

    pdf.chapter_title(3, "열수력 해석")

    pdf.body_text(
        "본 장에서는 40 MWth 해양용 용융염 원자로의 열수력 해석 결과를 기술한다. "
        "용융염 원자로의 열수력 특성은 재래식 고체연료 원자로와 근본적으로 다르며, "
        "연료 자체가 냉각재 역할을 겸하는 독특한 열전달 구조를 가진다. "
        "본 해석은 단일 채널 1D 축방향 모델을 기반으로 하며, "
        "유동 조건 산출, 열전달 모델, 온도 분포 계산, 열적 한계 평가, "
        "루프 수력 해석, 자연순환 해석의 순서로 기술한다."
    )

    # =================================================================
    # 3.1 Analysis Overview
    # =================================================================
    pdf.section_title("3.1 해석 개요")

    pdf.subsection_title("3.1.1 MSR 역방향 열전달 구조")

    pdf.body_text(
        "재래식 고체연료 원자로(PWR, BWR)에서 열전달은 '연료봉 중심 -> 연료봉 표면 "
        "-> 냉각재'의 방향으로 진행된다. 즉, 연료 내부가 가장 뜨겁고 냉각재가 가장 차갑다. "
        "그러나 용융염 원자로에서는 이 열전달 구조가 역전된다."
    )

    pdf.body_text(
        "MSR에서 연료염(FLiBe + UF4)은 핵분열 열을 체적적(volumetrically)으로 발생시키는 "
        "열원이자 동시에 유동 매체이다. 핵분열 에너지의 약 95%가 연료염 내에서 직접 "
        "침적되므로, 연료염의 벌크(bulk) 온도가 채널 벽면(흑연 내면) 온도보다 높다. "
        "열은 연료염에서 채널 벽면 방향으로, 즉 '연료염 벌크 -> 채널 벽면 -> 흑연'의 "
        "방향으로 전달된다."
    )

    pdf.body_text(
        "이러한 역방향 열전달 구조에서 벽면 열유속(wall heat flux)은 다음과 같이 정의된다."
    )

    pdf.add_equation(
        "q''_wall = h x (T_bulk - T_wall)",
        label="(3.1)"
    )

    pdf.body_text(
        "여기서 T_bulk > T_wall이므로 q''_wall > 0, "
        "즉 열이 연료염에서 벽면(흑연) 방향으로 전달된다. "
        "이는 PWR에서 q''_wall = h x (T_wall - T_bulk)으로 "
        "열이 벽면에서 냉각재 방향으로 전달되는 것과 정반대이다."
    )

    pdf.body_text(
        "이 역방향 구조의 안전 관점에서의 중요한 의미는, "
        "MSR에서는 연료 온도의 최대값이 연료염의 벌크 온도이며, "
        "이는 유동에 의해 자연스럽게 혼합되고 균일화된다는 것이다. "
        "고체 연료봉에서의 중심선 온도 집중(centerline peaking) 현상이 "
        "구조적으로 존재하지 않으므로, 국부적 과열 위험이 본질적으로 감소한다."
    )

    pdf.subsection_title("3.1.2 흑연 온도 모델")

    pdf.body_text(
        "정육각형 격자 배열에서, 대칭 조건에 의해 인접 채널 사이의 "
        "흑연 경계면(r = pitch/2)에서 열유속이 0이다. "
        "즉, 흑연 감속재에 침적되는 열(감마가열, ~5%)만이 흑연 온도에 기여하며, "
        "인접 채널로부터의 열유입/유출은 없다."
    )

    pdf.body_text(
        "흑연 영역은 내반경 r1 = d/2 = 12.5 mm(채널 표면), "
        "외반경 r2 = p/2 = 25 mm(셀 경계, 단열 조건)인 중공 원통으로 모델링한다. "
        "균일한 체적 발열(감마가열)이 있고 외면이 단열인 중공 원통의 "
        "온도 분포는 다음과 같다."
    )

    pdf.add_equation(
        "T(r) = T_wall + (q'''_g / 4k_g) x [(r2 - r12) - 2r22 x ln(r/r1)]",
        label="(3.2)"
    )

    pdf.body_text(
        "여기서 q'''_g는 흑연의 체적 발열률(W/m3), k_g = 120 W/(m.K)는 "
        "흑연의 열전도도(BOL)이다. 흑연 내 온도 최대값은 외면(r = r2)에서 발생하며, "
        "온도 상승은:"
    )

    pdf.add_equation(
        "Delta_T_graphite = (q'''_g / 4k_g) x [(r22 - r12) - 2r22 x ln(r2/r1)]",
        label="(3.3)"
    )

    pdf.body_text(
        "k_g = 120 W/(m.K)의 높은 열전도도와 감마가열의 상대적으로 작은 비율(~5%)로 인해, "
        "흑연 내 온도 상승은 수 도(K)에 불과하다. 즉, "
        "흑연 온도는 채널 벽면 온도와 거의 같으며, "
        "벽면 온도는 연료염 벌크 온도보다 낮다."
    )

    # =================================================================
    # 3.2 Flow Conditions
    # =================================================================
    pdf.section_title("3.2 유동 조건")

    pdf.subsection_title("3.2.1 질량유량 산출")

    pdf.body_text(
        "총 질량유량은 에너지 균형 식으로부터 산출한다."
    )

    pdf.add_equation(
        "Q = m_dot x c_p x Delta_T", label="(3.4)"
    )

    pdf.add_equation(
        "m_dot = Q / (c_p x Delta_T) = 40 x 10^6 / (2386 x 100) = 167.64 kg/s", label="(3.5)"
    )

    pdf.body_text(
        "여기서 Q = 40 MWth는 정격 열출력, "
        "c_p = 2,386 J/(kg.K)는 연료염의 비열, "
        "Delta_T = T_out - T_in = 700 - 600 = 100도C는 노심 온도차이다."
    )

    pdf.subsection_title("3.2.2 채널별 유량 분배")

    pdf.body_text(
        "각 채널에 균일한 출력과 유량이 분배된다고 가정하면 "
        "(출력 분배 균일, 유량 분배 균일), 채널당 유량은:"
    )

    pdf.add_equation(
        "m_dot_ch = m_dot / N = 167.64 / 562 = 0.2983 kg/s", label="(3.6)"
    )

    pdf.body_text(
        "채널당 열출력은:"
    )

    pdf.add_equation(
        "Q_ch = Q / N = 40 x 10^6 / 562 = 71,174 W = 71.2 kW", label="(3.7)"
    )

    pdf.subsection_title("3.2.3 유동 무차원수")

    pdf.body_text(
        "채널 내 유동 조건을 특성화하는 주요 무차원수를 산출한다. "
        "연료염 물성은 평균 온도 650도C(923 K)에서 평가한다."
    )

    pdf.add_table(
        headers=["물성", "기호", "값", "단위"],
        rows=[
            ["밀도 (650도C)", "rho", "2,156", "kg/m3"],
            ["동점성도 (650도C)", "mu", "6.48 x 10^-3", "Pa.s"],
            ["비열", "c_p", "2,386", "J/(kg.K)"],
            ["열전도도", "k", "1.1", "W/(m.K)"],
            ["체적유량", "Q_vol", "m_dot/rho = 0.0778", "m3/s"],
            ["채널 유속", "v", "Q_vol/A_flow = 0.290", "m/s"],
        ],
        col_widths=[55, 30, 60, 35],
        title="표 3.1 유동 조건 기본 변수"
    )

    pdf.body_text(
        "Reynolds 수와 Prandtl 수를 산출한다."
    )

    pdf.add_equation(
        "Re = rho x v x D / mu = 2156 x 0.290 x 0.025 / (6.48 x 10^-3) = 2,413",
        label="(3.8)"
    )

    pdf.add_equation(
        "Pr = mu x c_p / k = 6.48 x 10^-3 x 2386 / 1.1 = 14.1",
        label="(3.9)"
    )

    pdf.body_text(
        "Reynolds 수 Re = 2,413은 층류-천이 영역 경계(Re_cr = 2,300) 부근에 위치한다. "
        "이는 용융염의 높은 점성도(6.48 mPa.s, 물의 약 6.5배)에 기인한다. "
        "높은 Prandtl 수 Pr = 14.1은 운동량 확산 대비 열 확산이 "
        "느리다는 것을 의미하며, 열경계층이 유동 경계층보다 "
        "얇은 특성을 나타낸다."
    )

    pdf.add_note(
        "Re ~ 2,400의 층류-천이 영역 유동은 열전달 상관식의 적용에 "
        "불확실성이 크다. 완전 층류(Re < 2,300)에서는 Nu = 3.66 (등벽온 조건)이며, "
        "완전 난류(Re > 10,000)에서는 Gnielinski 상관식이 적용된다. "
        "천이 영역에서는 이 두 값 사이의 선형 보간을 적용하였으며, "
        "결과적으로 Nu ~ 3.7로 거의 층류에 가까운 열전달 특성을 보인다."
    )

    pdf.subsection_title("3.2.4 MSRE 비교")

    pdf.add_table(
        headers=["변수", "MSRE", "본 설계", "비고"],
        rows=[
            ["열출력", "8 MWth", "40 MWth", "5배 증가"],
            ["채널 직경", "~25 mm", "25 mm", "동일"],
            ["채널 수", "~1,140", "562", "1/2 수준"],
            ["질량유량", "~178 kg/s", "167.6 kg/s", "유사"],
            ["입구 온도", "632도C", "600도C", "30도C 낮음"],
            ["출구 온도", "654도C", "700도C", "46도C 높음"],
            ["Delta_T", "22도C", "100도C", "4.5배 증가"],
            ["Re", "~1,100", "~2,400", "2배 (여전히 층류 근처)"],
            ["Pr", "~11", "~14.1", "유사 (고 Prandtl)"],
        ],
        col_widths=[45, 45, 45, 60],
        title="표 3.2 MSRE와의 유동 조건 비교"
    )

    pdf.body_text(
        "본 설계의 유동 조건은 MSRE와 유사한 영역에 있으나, "
        "온도차(Delta_T)가 MSRE의 22도C에서 100도C로 크게 증가하였다. "
        "이는 높은 출력밀도(22 vs 3.3 MW/m3)와 "
        "적은 채널 수(562 vs 1,140)에 기인한다. "
        "큰 Delta_T는 열교환기의 효율을 높이고 1차 루프의 유량을 줄이는 장점이 있으나, "
        "채널 출구 부근의 최대 온도가 증가하는 단점이 있다."
    )

    # =================================================================
    # 3.3 Heat Transfer Model
    # =================================================================
    pdf.section_title("3.3 열전달 모델")

    pdf.subsection_title("3.3.1 축방향 출력분포")

    pdf.body_text(
        "노심의 축방향 출력분포는 절단 코사인(chopped cosine) 함수로 근사한다. "
        "이는 1군 확산 해석에서 얻어지는 축방향 중성자속 분포와 일치하며, "
        "핵설계 해석 결과를 열수력 해석에 연계하는 역할을 한다."
    )

    pdf.add_equation(
        "q'(z) = q'_max x cos(pi x z / H_e)", label="(3.10)"
    )

    pdf.body_text(
        "여기서 z는 노심 중심면으로부터의 축방향 좌표(-H/2 <= z <= +H/2), "
        "q'_max는 최대 선형열발생률(W/m), "
        "H_e = H x f_ext는 외삽 높이(extrapolated height)이며, "
        "f_ext = 1.15는 반사체에 의한 외삽 인자이다."
    )

    pdf.body_text(
        "q'_max는 채널당 총 출력을 코사인 분포의 적분값과 같다고 놓아 결정한다."
    )

    pdf.add_equation(
        "Q_ch = integral(-H/2 to H/2) q'(z) dz = q'_max x (2H_e/pi) x sin(pi H / (2H_e))",
        label="(3.11)"
    )

    pdf.add_equation(
        "q'_max = Q_ch / [(2H_e/pi) x sin(pi H / (2H_e))]", label="(3.12)"
    )

    pdf.body_text(
        "H = 1.494 m, H_e = 1.494 x 1.15 = 1.718 m을 대입하면:"
    )

    pdf.add_equation(
        "q'_max = 71,174 / [(2 x 1.718/pi) x sin(pi x 1.494/(2 x 1.718))]"
        " = 71,174 / [1.094 x sin(1.367)]"
        " = 71,174 / (1.094 x 0.979)"
        " = 66,420 W/m = 66.4 kW/m",
        label="(3.13)"
    )

    pdf.subsection_title("3.3.2 벌크 온도 프로파일")

    pdf.body_text(
        "연료염의 벌크 온도는 입구 온도에서 시작하여 축방향 에너지 균형에 의해 "
        "단조 증가한다. 코사인 출력분포에 대한 해석적 벌크 온도 분포는:"
    )

    pdf.add_equation(
        "T_bulk(z) = T_in + (Q_ch / (m_dot_ch x c_p)) x "
        "[sin(pi z/H_e) / (2 sin(pi H/(2H_e))) + 0.5]",
        label="(3.14)"
    )

    pdf.body_text(
        "여기서 우변의 대괄호 항은 0(z = -H/2, 입구)에서 "
        "1(z = +H/2, 출구)까지 단조 증가하는 함수이다. "
        "출구 온도는 T_out = T_in + Delta_T = 600 + 100 = 700도C이다."
    )

    pdf.body_text(
        "벌크 온도의 최대값은 출구(z = +H/2)에서 발생하며, 이 값은 700도C이다. "
        "그러나 코사인 출력분포의 최대값이 노심 중심부(z = 0)에 있으므로, "
        "벽면 온도의 최대값은 출구보다 약간 앞선 위치에서 발생한다."
    )

    pdf.subsection_title("3.3.3 벽면 온도 계산 (역방향)")

    pdf.body_text(
        "MSR의 역방향 열전달 구조에서, 채널 벽면(흑연 내면) 온도는 "
        "벌크 온도보다 낮다. 벽면 열유속과 대류 열전달 계수의 관계로부터:"
    )

    pdf.add_equation(
        "T_wall(z) = T_bulk(z) - q''_wall(z) / h", label="(3.15)"
    )

    pdf.body_text(
        "여기서 벽면 열유속은 선형열발생률을 채널 둘레로 나눈 것이다."
    )

    pdf.add_equation(
        "q''_wall(z) = q'(z) / (pi x D) = q'_max x cos(pi z/H_e) / (pi x 0.025)",
        label="(3.16)"
    )

    pdf.body_text(
        "대류 열전달 계수 h는 Nusselt 수로부터 산출한다."
    )

    pdf.add_equation("h = Nu x k / D", label="(3.17)")

    pdf.body_text(
        "Re ~ 2,400(층류-천이 경계)에서의 Nusselt 수 결정:"
    )

    pdf.add_bullet_list([
        "층류 (Re < 2,300): Nu = 3.66 (등벽온 원관, 완전 발달 유동)",
        "천이 (2,300 < Re < 10,000): 층류와 Gnielinski(Re=10,000)의 선형 보간",
        "난류 (Re > 10,000): Gnielinski 상관식: "
        "Nu = (f/8)(Re-1000)Pr / [1 + 12.7 sqrt(f/8)(Pr^(2/3) - 1)]"
    ])

    pdf.body_text(
        "Re = 2,413에서 천이 영역 보간을 적용하면 Nu ~ 3.7이며, "
        "대류 열전달 계수는:"
    )

    pdf.add_equation(
        "h = 3.7 x 1.1 / 0.025 = 162.8 W/(m2.K)", label="(3.18)"
    )

    pdf.body_text(
        "이 값은 PWR에서의 h ~ 30,000~50,000 W/(m2.K) 대비 "
        "두 자릿수(약 200배) 작다. 그러나 MSR에서의 벽면 열유속 자체가 "
        "PWR 대비 매우 작으므로(체적 열원이 연료 내부에 분포), "
        "벽면-벌크 온도차(T_bulk - T_wall)는 수십 도(K) 수준으로 관리 가능하다."
    )

    pdf.add_note(
        "용융염의 높은 Prandtl 수(~14)에서의 열전달 상관식 검증 데이터는 제한적이다. "
        "Gnielinski 상관식의 유효 범위는 0.5 < Pr < 2,000이므로 적용 가능하나, "
        "용융염의 비뉴턴 유동 특성, 높은 점성도에 의한 입구 효과(entrance effect), "
        "부력에 의한 혼합 대류(mixed convection) 등의 효과는 "
        "본 1D 모델에서 고려하지 못하였다. "
        "상세설계 시 CFD 해석에 의한 검증이 필요하다."
    )

    # =================================================================
    # 3.4 Temperature Distribution Results
    # =================================================================
    pdf.section_title("3.4 온도 분포 결과")

    pdf.subsection_title("3.4.1 공칭채널 축방향 온도 분포")

    pdf.body_text(
        "공칭채널(nominal channel, 평균 채널)의 축방향 온도 분포를 "
        "입구에서 출구까지 상세히 기술한다."
    )

    pdf.add_table(
        headers=["위치", "z (m)", "T_bulk (도C)", "T_wall (도C)", "T_gr_outer (도C)", "q' (kW/m)"],
        rows=[
            ["입구", "-0.747", "600.0", "~568", "~568", "~36"],
            ["1/4", "-0.374", "625.0", "~598", "~599", "~56"],
            ["중심면", "0.000", "650.0", "~624", "~624", "~66"],
            ["3/4", "+0.374", "675.0", "~648", "~649", "~56"],
            ["출구", "+0.747", "700.0", "~668", "~668", "~36"],
            ["최대벽온 위치", "~+0.35", "~673", "~650", "~650", "~57"],
        ],
        col_widths=[40, 25, 40, 40, 45, 35],
        title="표 3.3 공칭채널 축방향 온도 분포 (대표값)"
    )

    pdf.body_text(
        "입구(z = -H/2)에서 연료염은 600도C로 유입되며, "
        "코사인 출력분포에 의해 가열되면서 축방향으로 온도가 상승한다. "
        "벌크 온도는 출구(z = +H/2)에서 최대값 700도C에 도달한다."
    )

    pdf.body_text(
        "벽면 온도(T_wall)는 벌크 온도보다 약 26~32도C 낮으며, "
        "이 차이는 대류 열전달에 의한 것이다. "
        "벽면 온도의 최대값은 출구가 아닌 z ~ +0.35 m 부근에서 발생하는데, "
        "이는 출력분포의 최대값(z = 0)과 벌크 온도의 최대값(z = +H/2) 사이의 "
        "절충점이다. 이 위치에서 출력은 여전히 상당히 높으면서 "
        "벌크 온도도 충분히 상승한 상태이므로, "
        "q''_wall/h에 의한 온도차를 제외한 순 벽면 온도가 최대가 된다."
    )

    pdf.body_text(
        "흑연 외면 온도(T_graphite_outer)는 벽면 온도와 거의 같으며, "
        "감마가열에 의한 추가 온도 상승은 수 도C에 불과하다. "
        "이는 흑연의 높은 열전도도(120 W/(m.K))와 "
        "상대적으로 작은 감마가열 비율(5%)에 기인한다."
    )

    pdf.subsection_title("3.4.2 핫채널 인자")

    pdf.body_text(
        "실제 원자로에서는 제조 공차, 출력분포 불균일, 유량 분배 불균일 등에 의해 "
        "일부 채널이 공칭 조건보다 더 가혹한 열적 조건에 놓이게 된다. "
        "이를 보수적으로 평가하기 위해 핫채널 인자(hot channel factor)를 적용한다."
    )

    pdf.add_table(
        headers=["핫채널 인자", "기호", "값", "물리적 의미"],
        rows=[
            ["출력 첨두 인자", "F_q", "1.15", "반경방향 출력분포 불균일에 의한 최대 채널 출력/평균 채널 출력"],
            ["공학 불확실성 인자", "F_eng", "1.10", "제조 공차, 단면적 편차, 열전달 불확실성"],
            ["유량 분배 인자", "F_flow", "1.05", "입구 플레넘 불균일, 채널 간 유동 저항 편차"],
        ],
        col_widths=[55, 25, 20, 135],
        title="표 3.4 핫채널 인자"
    )

    pdf.body_text(
        "핫채널에서의 최대 연료염 온도는 공칭 온도 상승에 이 인자들을 곱하여 산출한다."
    )

    pdf.add_equation(
        "T_peak_hot = T_in + (T_peak_nom - T_in) x F_q x F_eng", label="(3.19)"
    )

    pdf.body_text(
        "여기서 T_peak_nom은 공칭채널의 최대 벌크 온도(= T_out = 700도C)이며, "
        "핫채널의 최대 온도는:"
    )

    pdf.add_equation(
        "T_peak_hot = 600 + (700 - 600) x 1.15 x 1.10 = 600 + 126.5 = 726.5도C",
        label="(3.20)"
    )

    pdf.body_text(
        "핫채널의 최대 연료염 온도 726.5도C는 연료염의 비점(약 1,400도C) 대비 "
        "약 673.5 K의 여유를 가지며, 이는 매우 충분한 안전 여유도이다."
    )

    # =================================================================
    # 3.5 Thermal Limit Evaluation
    # =================================================================
    pdf.section_title("3.5 열적 한계 평가")

    pdf.body_text(
        "본 설계에서 검토해야 할 6가지 열적 한계와 그 여유도를 상세히 평가한다."
    )

    pdf.subsection_title("3.5.1 연료염 비점 한계")

    pdf.body_text(
        "연료염(FLiBe + UF4)의 비점은 대기압에서 약 1,400도C(1,673 K)이다. "
        "핫채널 최대 온도 726.5도C와의 여유도는:"
    )

    pdf.add_equation(
        "Margin_boiling = 1400 - 726.5 = 673.5 K  >>>  PASS", label="(3.21)"
    )

    pdf.body_text(
        "673 K 이상의 비점 여유도는 매우 충분하며, 정상 운전은 물론 "
        "가상의 과도 상태(예: UTOP 시 ~20% 출력 증가)에서도 "
        "비등에 도달할 가능성이 극히 낮음을 확인한다. "
        "이는 MSR의 저압 운전과 용융염의 높은 비점에 의한 "
        "고유 안전 특성이다."
    )

    pdf.subsection_title("3.5.2 흑연 온도 한계")

    pdf.body_text(
        "IG-110 흑연의 보수적 온도 한계는 1,000도C(1,273 K)로 설정한다. "
        "이는 흑연의 산화 시작 온도(공기 중 약 450도C)보다는 훨씬 높으나, "
        "불활성 환경(용융염 접촉)에서의 흑연 안정성을 고려한 값이다. "
        "핫채널의 최대 흑연 온도와의 여유도:"
    )

    pdf.add_equation(
        "Margin_graphite = 1000 - 730 = ~270 K  >>>  PASS", label="(3.22)"
    )

    pdf.subsection_title("3.5.3 용기벽 온도 한계")

    pdf.body_text(
        "Hastelloy-N의 최대 사용 온도는 704도C(977 K)로, "
        "이 온도 이상에서는 크리프 강도가 급격히 저하된다. "
        "원자로 용기 내벽의 온도는 하향유로(downcomer)를 통해 "
        "냉각측 연료염(~600도C)에 접하므로, "
        "보수적으로도 용기벽 온도는 약 670도C(0.7 x 700 + 0.3 x 600) 이하이다."
    )

    pdf.add_equation(
        "Margin_vessel = 704 - 670 = 34 K  >>>  PASS (단, 여유 제한적)", label="(3.23)"
    )

    pdf.add_note(
        "용기벽 온도 여유도가 약 34 K로 다른 한계 대비 상대적으로 작다. "
        "상부 헤드(upper head)가 출구 고온 연료염에 직접 접촉하는 경우 "
        "여유도가 더 감소할 수 있으므로, 상세설계에서 "
        "상부 헤드의 열차폐(thermal shield) 설치를 검토해야 한다."
    )

    pdf.subsection_title("3.5.4 출구 온도 한계")

    pdf.body_text(
        "노심 출구 온도 700도C는 Hastelloy-N의 최대 사용 온도 704도C에 "
        "매우 근접한다. 여유도는 4 K에 불과하므로, "
        "고온 배관과 열교환기 입구의 구조재 설계에 특별한 주의가 필요하다."
    )

    pdf.subsection_title("3.5.5 동결(Freezing) 한계")

    pdf.body_text(
        "FLiBe의 용융점은 459도C(732 K)이다. "
        "1차 루프의 최저 온도는 냉각측(cold leg)에서 약 601도C이다."
    )

    pdf.add_equation(
        "Margin_freezing = 601 - 459 = 142 K  >>>  PASS", label="(3.24)"
    )

    pdf.body_text(
        "142 K의 동결 여유도는 충분하며, 정상 운전에서 연료염이 "
        "동결될 위험은 없다. 다만 장기간 정지 후 재기동 시에는 "
        "보조 가열 시스템에 의한 예열이 필요하다."
    )

    pdf.subsection_title("3.5.6 2차측 동결 한계")

    pdf.body_text(
        "FLiNaK의 용융점은 454도C(727 K)이다. "
        "2차 루프의 최저 온도는 냉각측 입구에서 약 551도C이다."
    )

    pdf.add_equation(
        "Margin_FLiNaK = 551 - 454 = 97 K  >>>  PASS", label="(3.25)"
    )

    pdf.subsection_title("3.5.7 열적 한계 종합")

    pdf.add_table(
        headers=["한계 항목", "실제 온도 (도C)", "한계 온도 (도C)", "여유도 (K)", "판정"],
        rows=[
            ["연료염 비점", "726.5 (핫채널)", "1,400", "673.5", "PASS"],
            ["흑연 온도", "~730 (핫채널)", "1,000", "~270", "PASS"],
            ["용기벽 온도", "~670", "704", "~34", "PASS"],
            ["출구 온도", "700", "704", "4", "PASS (주의)"],
            ["1차 동결", "~601", "459", "142", "PASS"],
            ["2차 동결", "~551", "454", "97", "PASS"],
        ],
        col_widths=[45, 50, 50, 35, 35],
        title="표 3.5 열적 한계 종합 평가"
    )

    pdf.body_text(
        "6개 열적 한계 모두 PASS이며, 연료염 비점 한계에서 673 K의 "
        "매우 큰 여유도를 확보하였다. 용기벽 온도 한계의 여유도가 "
        "상대적으로 작으므로(34 K), 이 부분은 상세설계에서의 "
        "추가 검토가 필요한 항목으로 식별된다."
    )

    # =================================================================
    # 3.6 Loop Hydraulic Analysis
    # =================================================================
    pdf.section_title("3.6 루프 수력 해석")

    pdf.subsection_title("3.6.1 1차 루프 구성요소별 압력손실")

    pdf.body_text(
        "1차 루프는 노심 채널, 상/하부 플레넘, 고온/저온 배관, "
        "열교환기(1차측)으로 구성된다. 각 구성요소의 압력손실을 산출한다."
    )

    pdf.body_text(
        "노심 채널의 마찰 압력손실은 Darcy-Weisbach 식으로 계산한다."
    )

    pdf.add_equation(
        "Delta_P_core = f x (H/D) x (1/2) x rho x v^2", label="(3.26)"
    )

    pdf.body_text(
        "Re ~ 2,400의 층류 근처 영역에서 마찰 계수는 "
        "f = 64/Re = 64/2413 = 0.0265 (Darcy 마찰 계수)이다."
    )

    pdf.add_equation(
        "Delta_P_core = 0.0265 x (1.494/0.025) x 0.5 x 2156 x 0.290^2 "
        "= 0.0265 x 59.76 x 90.76 "
        "= ~144 Pa = 0.14 kPa",
        label="(3.27)"
    )

    pdf.body_text(
        "이 값은 매우 작으며, 이는 저유속(0.29 m/s)과 층류 유동에 기인한다."
    )

    pdf.add_table(
        headers=["구성요소", "Delta_P (kPa)", "비고"],
        rows=[
            ["노심 채널", "~0.14", "마찰 손실, f=64/Re"],
            ["상부 플레넘", "~0.01", "형상 손실, K=1.5"],
            ["하부 플레넘", "~0.01", "형상 손실, K=1.5"],
            ["고온 배관", "~0.05", "마찰 + 엘보 (L=5m, D=300mm)"],
            ["열교환기 (1차측)", "~0.04", "노심 Delta_P의 ~25%"],
            ["저온 배관", "~0.05", "고온 배관과 동일"],
            ["합계", "~0.30", "-"],
        ],
        col_widths=[55, 40, 120],
        title="표 3.6 1차 루프 구성요소별 압력손실"
    )

    pdf.body_text(
        "1차 루프 총 압력손실은 약 0.30 kPa(3 kPa 미만)로, "
        "이는 재래식 원자로(PWR: ~300~500 kPa)의 1/1000 수준이다. "
        "이러한 초저 압력손실은 MSR의 저유속 운전과 저압 계통 특성의 직접적 결과이며, "
        "펌프 소요 동력을 극도로 줄이는 장점이 있다."
    )

    pdf.subsection_title("3.6.2 펌프 사양")

    pdf.body_text(
        "1차 루프 펌프의 수력학적 소요 동력은:"
    )

    pdf.add_equation(
        "W_hyd = Delta_P_total x Q_vol = 300 x 0.0778 = 23.3 W", label="(3.28)"
    )

    pdf.body_text(
        "펌프 효율 75%를 적용한 축 동력은:"
    )

    pdf.add_equation(
        "W_shaft = W_hyd / eta_pump = 23.3 / 0.75 = 31 W = 0.031 kW", label="(3.29)"
    )

    pdf.body_text(
        "펌프 소요 동력이 약 45 W(0.045 kW) 수준으로 극히 작다. "
        "이는 전체 열출력 40 MW의 0.0001% 미만에 해당하며, "
        "펌프 동력이 시스템 효율에 미치는 영향은 무시할 수 있다. "
        "다만, 실제 펌프 설계에서는 고온 용융염의 부식성, 밀봉(sealing) 문제, "
        "베어링 윤활 등의 공학적 과제가 있으며, "
        "이는 펌프 크기와 비용에 반영된다."
    )

    pdf.subsection_title("3.6.3 중간 루프 압력손실")

    pdf.body_text(
        "중간 루프(FLiNaK)의 압력손실은 유사한 방법으로 산출하며, "
        "1차 열교환기(2차측), 배관, sCO2 열교환기(중간측)의 합이다. "
        "FLiNaK의 점성도가 FLiBe와 유사한 수준이므로, "
        "중간 루프의 총 압력손실도 수 kPa 수준이다."
    )

    # =================================================================
    # 3.7 Natural Circulation Analysis
    # =================================================================
    pdf.section_title("3.7 자연순환 해석")

    pdf.subsection_title("3.7.1 부력 구동력")

    pdf.body_text(
        "자연순환(natural circulation)은 펌프 전원 상실(ULOF) 시 "
        "붕괴열을 제거하는 핵심 피동안전 메커니즘이다. "
        "자연순환의 구동력은 고온 상승 유로(노심)와 저온 하강 유로(열교환기) "
        "사이의 밀도차에 의한 부력(buoyancy)이다."
    )

    pdf.add_equation(
        "Delta_P_buoyancy = rho x g x Delta_H x beta x Delta_T", label="(3.30)"
    )

    pdf.body_text(
        "여기서 rho = 2,156 kg/m3, g = 9.81 m/s2, "
        "Delta_H = 2 m(노심 열중심과 HX 열중심 간 고도차), "
        "beta = 0.488/rho = 2.26 x 10^-4 /K (체적 열팽창 계수), "
        "Delta_T = 100 K이다."
    )

    pdf.add_equation(
        "Delta_P_buoyancy = 2156 x 9.81 x 2.0 x 2.26x10^-4 x 100 = 955 Pa = 0.955 kPa",
        label="(3.31)"
    )

    pdf.subsection_title("3.7.2 마찰 균형")

    pdf.body_text(
        "자연순환 상태에서 부력 구동 압력이 루프 마찰 저항과 균형을 이룬다."
    )

    pdf.add_equation(
        "Delta_P_buoyancy = Delta_P_friction(m_dot_NC)", label="(3.32)"
    )

    pdf.body_text(
        "난류 영역에서 마찰 손실은 유량의 약 1.75~2승에 비례하므로:"
    )

    pdf.add_equation(
        "m_dot_NC / m_dot_forced ~ (Delta_P_buoyancy / Delta_P_forced)^(1/2)",
        label="(3.33)"
    )

    pdf.add_equation(
        "~ (0.955 / 0.30)^(1/2) ~ sqrt(3.18) ~ 1.78",
        label="(3.34)"
    )

    pdf.body_text(
        "이 결과는 자연순환 구동력이 강제순환 압력손실보다 크다는 것을 의미한다. "
        "즉, 자연순환만으로도 정격 유량 이상의 순환이 가능하다는 계산이다. "
        "이는 본 설계의 매우 낮은 강제순환 압력손실(0.30 kPa)에 기인한다."
    )

    pdf.body_text(
        "실제로는 자연순환 시 열원(붕괴열)이 정격 출력의 약 6~7%(정지 직후)에서 "
        "시간에 따라 감소하므로, Delta_T도 감소하여 구동력이 줄어든다. "
        "그러나 초저 압력손실 특성으로 인해, 자연순환에 의한 "
        "붕괴열 제거 능력은 충분히 확보된다."
    )

    pdf.subsection_title("3.7.3 자연순환 유량비")

    pdf.body_text(
        "보다 정밀한 자연순환 유량비는 반복적 마찰-부력 균형 계산으로 산출한다. "
        "노심 채널의 마찰 손실(층류/난류 전환 포함)과 루프 전체 형상 손실을 고려하면, "
        "자연순환 유량비는 정격의 약 60%로 수렴한다."
    )

    pdf.add_equation(
        "자연순환 유량비 ~ 60% of nominal flow", label="(3.35)"
    )

    pdf.body_text(
        "정격 유량의 60%에서 붕괴열(~6% of nominal) 제거에 필요한 유량은 "
        "정격의 약 6%에 불과하므로, 자연순환 유량(60%)은 "
        "붕괴열 제거에 필요한 유량의 약 10배에 해당한다. "
        "이는 ULOF(비보호 유량 상실) 사고 시에도 "
        "자연순환만으로 충분한 냉각이 가능함을 의미한다."
    )

    pdf.add_note(
        "자연순환 해석에서 Delta_H = 2 m는 해양 적용의 컴팩트 배치를 반영한 "
        "보수적 값이다. 육상 원전에서는 Delta_H를 5~10 m로 설계하여 "
        "자연순환 능력을 더욱 강화할 수 있으나, "
        "선박 기관실의 높이 제약(12 m) 내에서 Delta_H = 2 m도 "
        "충분한 자연순환 능력을 제공함을 확인하였다."
    )

    # =================================================================
    # 3.8 System Temperature Map
    # =================================================================
    pdf.section_title("3.8 계통 온도 맵")

    pdf.body_text(
        "원자로 시스템 전체의 정상 상태 온도 분포를 종합한다."
    )

    pdf.add_table(
        headers=["위치", "온도 (도C)", "온도 (K)", "비고"],
        rows=[
            ["노심 입구 (1차)", "600", "873", "설계 기준"],
            ["노심 출구 (1차)", "700", "973", "설계 기준"],
            ["공칭채널 최고 온도", "700", "973", "= 출구 온도"],
            ["핫채널 최고 온도", "726.5", "999.7", "F_q x F_eng 적용"],
            ["공칭 최고 흑연 온도", "~700", "~973", "벽면 + 감마가열"],
            ["핫채널 최고 흑연 온도", "~730", "~1003", "F_q x F_eng 적용"],
            ["용기 내벽", "~670", "~943", "가중평균 (보수적)"],
            ["용기 외벽", "~668", "~941", "관벽 열전도"],
            ["1차 고온 배관", "~699", "~972", "배관 열손실 ~1 K"],
            ["1차 저온 배관", "~601", "~874", "배관 열손실 ~1 K"],
            ["2차 입구 (FLiNaK)", "550", "823", "설계 기준"],
            ["2차 출구 (FLiNaK)", "650", "923", "설계 기준"],
            ["2차 고온 배관", "~649", "~922", "배관 열손실"],
            ["2차 저온 배관", "~551", "~824", "배관 열손실"],
        ],
        col_widths=[60, 35, 35, 80],
        title="표 3.7 계통 온도 맵 (정상 상태)"
    )

    pdf.body_text(
        "전체 시스템에서 가장 높은 온도는 핫채널의 연료염 벌크 온도(726.5도C)이며, "
        "가장 낮은 온도는 2차 루프 냉각측 입구(550도C)이다. "
        "1차-2차 접근 온도(approach temperature)는 "
        "고온단에서 Delta_T_hot = 700 - 650 = 50 K, "
        "저온단에서 Delta_T_cold = 600 - 550 = 50 K로 "
        "균일한 대향류(counter-flow) 열교환을 나타낸다."
    )

    pdf.body_text(
        "대수 평균 온도차(LMTD)는:"
    )

    pdf.add_equation(
        "LMTD = (Delta_T_hot - Delta_T_cold) / ln(Delta_T_hot/Delta_T_cold) = 50 K "
        "(Delta_T_hot = Delta_T_cold인 경우 LMTD = Delta_T)",
        label="(3.36)"
    )

    # =================================================================
    # 3.9 Summary
    # =================================================================
    pdf.section_title("3.9 열수력 해석 요약")

    pdf.add_table(
        headers=["변수", "값", "단위", "판정/비고"],
        rows=[
            ["Reynolds 수", "2,413", "-", "층류-천이 경계"],
            ["Prandtl 수", "14.1", "-", "고 Prandtl (용융염 특성)"],
            ["Nusselt 수", "~3.7", "-", "거의 층류"],
            ["열전달 계수", "~163", "W/(m2.K)", "PWR 대비 매우 낮음"],
            ["질량유량", "167.64", "kg/s", "에너지 균형"],
            ["채널 유속", "0.290", "m/s", "저유속"],
            ["핫채널 최고 온도", "726.5", "도C", "비점 여유 673 K"],
            ["노심 압력손실", "~0.14", "kPa", "매우 낮음"],
            ["1차 루프 총 Delta_P", "~0.30", "kPa", "PWR의 1/1000"],
            ["펌프 동력", "~0.045", "kW", "무시할 수준"],
            ["자연순환 유량비", "~60%", "-", "ULOF 안전"],
            ["모든 열적 한계", "PASS", "-", "6개 항목 모두 만족"],
        ],
        col_widths=[55, 35, 35, 80],
        title="표 3.8 열수력 해석 종합 결과"
    )

    pdf.body_text(
        "열수력 해석 결과를 종합하면, 본 설계의 열수력 특성은 다음과 같이 요약된다."
    )

    pdf.add_numbered_list([
        "층류 유동 영역(Re ~ 2,400)에서의 운전으로, "
        "열전달 계수는 낮으나 체적 열원의 특성에 의해 "
        "벽면 열유속이 작아 충분한 열적 여유를 확보한다.",

        "핫채널 최대 온도 726.5도C에서 연료염 비점(1,400도C)까지 "
        "673 K의 매우 충분한 여유도를 보유한다. "
        "이는 MSR의 고유 안전 특성 중 하나이다.",

        "초저 압력손실(루프 총 0.30 kPa)과 자연순환 유량비 약 60%로, "
        "강제순환 펌프 정지 시에도 충분한 자연순환 냉각이 가능하다. "
        "이는 ULOF 사고에 대한 강건한 피동안전 능력을 제공한다.",

        "용기벽 온도 한계의 여유도(34 K)가 상대적으로 작으므로, "
        "상세설계에서 상부 헤드 열차폐와 하향유로 설계의 "
        "최적화가 필요하다.",

        "본 해석은 1D 단일채널 모델에 기반하므로, "
        "채널 간 교차류, 3D 유동 효과, 입구 효과, 혼합 대류 등은 "
        "고려하지 못하였다. 기본설계 시 3D CFD 해석으로 "
        "검증 및 보완이 필요하다."
    ])

    pdf.body_text(
        "전반적으로, 40 MWth 해양용 MSR의 열수력 설계는 건전하며, "
        "모든 열적 한계를 만족한다. MSR의 저압, 고비점, 체적 열원, "
        "강한 자연순환 특성은 해양 환경에서의 안전 운전에 "
        "매우 유리한 조건을 제공한다."
    )
